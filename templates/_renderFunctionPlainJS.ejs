
type Microfrontend<%-i+1-%>RenderCb = (hostElement: HTMLElement, context: Microfrontend<%-i+1-%>Context) => Promise<OpenMicrofrontendLifecycleHooks>;

// Render function for Microfrontend: <%-spec.microfrontends[i].name%>
export function onRender<%-safeMicrofrontendNames[i]-%>(cb: Microfrontend<%-i+1-%>RenderCb): void {

    (window as any)['<%-spec.microfrontends[i].globalLaunchFunction-%>'] = async (hostElement: HTMLElement, ...otherArgs: any[]) => {
        // Temporary Mashroom Server compatibility, until it supports OpenMicrofrontends natively
        const enableTempMashroomComp = otherArgs.length === 2 && otherArgs[0].appId && otherArgs[0].proxyPaths;

        const defaultContext: Omit<Microfrontend<%-i+1-%>Context, 'apiProxyPaths'> = {
            id: 'default',
            lang: 'en',
            user: {
                guest: true,
                username: 'guest',
                displayName: 'guest',
                <% if (spec.microfrontends[i].frontendPermissions && spec.microfrontends[i].frontendPermissions.length > 0) { %>
                permissions: {} as any,
                <% } %>
            },
            config: <%-JSON.stringify(spec.microfrontends[i].config.default, null, 4)-%>,
            <% if (spec.microfrontends[i].messages) { %>
            messageBus: {
                publish(topic: any) { console.warn(`[OpenMicrofrontends] Publish to topic ${topic} but no messageBus present!`); },
                subscribe(topic: any) { console.warn(`[OpenMicrofrontends] Subscribe to topic ${topic} but no messageBus present!`); },
                unsubscribe(topic: any) {},
            },
            <% } %>
        };

        let context: Microfrontend<%-i+1-%>Context;
        if (enableTempMashroomComp) {
            const {appId, lang, user, proxyPaths, appConfig} = otherArgs[0];
            const {messageBus} = otherArgs[1];
            context = {
                ...defaultContext,
                id: appId,
                lang,
                user,
                <% if (spec.microfrontends[i].apiProxies && Object.keys(spec.microfrontends[i].apiProxies).length > 0) { %>
                apiProxyPaths: proxyPaths,
                <% } %>
                config: appConfig,
                <% if (spec.microfrontends[i].messages) { %>
                messageBus,
                <% } %>
            };
        } else {
            // Default
            context = {
                ...defaultContext,
                ...otherArgs[0],
            };
        }

        // Validate
        <% if (spec.microfrontends[i].apiProxies && Object.keys(spec.microfrontends[i].apiProxies).length > 0) { %>
        if (!context.apiProxyPaths) {
            throw new Error('[OpenMicrofrontends] No apiProxyPaths provided!');
        }
        <% } -%>

        console.debug('[OpenMicrofrontends] Starting Microfrontend "<%-spec.microfrontends[i].name-%>" with context:', context);
        const result = await cb(hostElement, context);

        if (enableTempMashroomComp) {
            return {
                willBeRemoved: result?.onRemove,
            };
        }
        return result;
    }
}
