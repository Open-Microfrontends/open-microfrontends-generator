
const fallbackAssetTimestamp = Math.floor(Date.now() / 10000) * 10;

/* Type Parameters */

<% if (spec.microfrontends[i].messages && Object.keys(spec.microfrontends[i].messages).length > 0) { %>
    type Microfrontend<%-i+1 %>MessagesPublish = Record<string, any>;
    type Microfrontend<%-i+1 %>MessagesSubscribe = Record<string, any>;
<% } else { %>
    type Microfrontend<%-i+1 %>MessagesPublish = undefined;
    type Microfrontend<%-i+1 %>MessagesSubscribe = undefined;
<%  } %>

/* Type-safe MessageBus slice for the client */

<% if (spec.microfrontends[i].messages && Object.keys(spec.microfrontends[i].messages).length > 0) { %>
    type Microfrontend<%-i+1-%>ClientMessageBus = {
    <% Object.keys(spec.microfrontends[i].messages).forEach((topic, idx) => { %>
        <% if (spec.microfrontends[i].messages[topic].subscribe) { %>
        publish(topic: '<%-topic-%>%>', data: <%-messageSchemaTypes[idx][topic].ifName-%>): void;
        <% } %>
        <% if (spec.microfrontends[i].messages[topic].publish) { %>
        subscribe(topic: '<%-topic-%>%>', cb: (data: <%-messageSchemaTypes[idx][topic].ifName-%>) => void): void;
        unsubscribe(topic: '<%-topic-%>%>', cb: (data: <%-messageSchemaTypes[idx][topic].ifName-%>) => void): void;
        <% } %>
    <% }) %>
    };
<% } %>

/* Default config  */

const defaultConfig<%i+1%> = <%-JSON.stringify(spec.microfrontends[i].config.default, null, 2)-%>;

/* Renderer context type with aligned config and message bus */

type Microfrontend<%-i+1%>ClientContext = Omit<
    OpenMicrofrontendsClientContext<Partial<Microfrontend<%-i+1%>Config>, undefined, undefined, Microfrontend<%-i+1%>MessagesPublish, Microfrontend<%-i+1%>MessagesSubscribe>,
'apiProxyPaths' | 'permissions' | 'user'>;

/* Microfrontend setup */

const getHostBackendMicrofrontendSetup = async (id: string, name: string): Promise<HostBackendMicrofrontendSetup> => {
    const preloadedSetup = window[`__om__setup__${name}_${id}`];
    if (preloadedSetup) {
        return preloadedSetup;
    }
    try {
        const response = await fetch(`${omBasePath}/${name}${omSetupSubPath}`);
        return await response.json();
    } catch (e) {
        console.error(`[OpenMicrofrontends] Loading setup of Microfrontend ${name} failed. Did you add the necessary Host Integration?`, e);
        throw new Error(`[OpenMicrofrontends] Loading setup of Microfrontend ${name} failed!`);
    }
};

/* Start function */

export async function start<%-safeMicrofrontendNames[i]-%>(hostElement: HTMLElement, context: Microfrontend<%-i+1%>ClientContext) {
    const addedElements: Array<HTMLElement> = [];
    const exportedModules: Array<any> = [];
    const assetsPath = `${omBasePath}/<%-safeMicrofrontendNames[i]-%>${omAssetsSubPath}`;
    const proxiesPath = `${omBasePath}/<%-safeMicrofrontendNames[i]-%>${omProxiesSubPath}`;
    const setup = await getHostBackendMicrofrontendSetup(context.id, '<%-safeMicrofrontendNames[i]-%>');
    const {assetBuildTimestampOrVersion, rewrittenImportMaps, ...serverContext} = setup;
    const serverSideRendered = !!window[`__om_ssr_<%-safeMicrofrontendNames[i]-%>_${context.id}__`];

    if (serverSideRendered) {
        console.info('[OpenMicrofrontends] Found server-side rendered Microfrontend "<%-spec.microfrontends[i].name%>"');
    }

    <% if (spec.microfrontends[i].assets.css) { %>
        if (!serverSideRendered) {
            // Add stylesheets
            <% for (const cssResource of spec.microfrontends[i].assets.css) { %>
                addCssLinkTag(toFullUrl(assetsPath, `<%-cssResource%>?v=${assetBuildTimestampOrVersion ?? fallbackAssetTimestamp}`), addedElements);
            <% } %>
        }
    <% } %>

    const jsUrls = [
        <% for (const jsResource of spec.microfrontends[i].assets.js.initial) { %>
            toFullUrl(assetsPath, `<%-jsResource%>?v=${assetBuildTimestampOrVersion ?? fallbackAssetTimestamp}`),
        <% } %>
    ];
    <% if (!spec.microfrontends[i].assets.js.moduleSystem || spec.microfrontends[i].assets.js.moduleSystem === 'none') { %>
        // Load JS assets consecutively (no modules)
        try {
            for (const jsUrl of jsUrls) {
                await addJsScriptTag(jsUrl, addedElements);
            }
        } catch (e) {
            throw new Error('[OpenMicrofrontends] Loading assets of Microfrontend "<%-spec.microfrontends[i].name%>" failed!');
        }
    <% } else if (spec.microfrontends[i].assets.js.moduleSystem === 'ESM') { %>
        // Load initial modules consecutively (ESM)
        try {
            for (const jsUrl of jsUrls) {
                const module = await import(jsUrl);
                if (module) {
                  exportedModules.push(module);
                }
            }
        } catch (e) {
            throw new Error('[OpenMicrofrontends] Loading assets of Microfrontend "<%-spec.microfrontends[i].name%>" failed!');
        }

    <% } else if (spec.microfrontends[i].assets.js.moduleSystem === 'SystemJS') { %>
        // Load initial modules consecutively (SystemJS)
        if (typeof System === 'undefined') {
            throw new Error('[OpenMicrofrontends] Microfrontend "<%-spec.microfrontends[i].name%>" requires SystemJS but is not available!');
        }

        const initialModuleMapping = {};
        jsUrls.forEach((jsUrl) => {
            const moduleWithoutQuery = jsUrl.split('?')[0];
            initialModuleMapping[moduleWithoutQuery] = jsUrl;
        });
        const finalImportMap = {
            imports: {
                ...initialModuleMapping,
                <% if (spec.microfrontends[i].assets.js.importMap?.imports) { -%>
                    ...rewrittenImportMaps?.imports ?? <%-JSON.stringify(spec.microfrontends[i].assets.js.importMap.imports, null, 2)%>
                <% } %>
            },
        };
        installSystemJSImportMap(jsUrls, finalImportMap);

        try {
            for (const jsUrl of jsUrls) {
                const module = await System.import(jsUrl);
                if (module) {
                  exportedModules.push(module);
                }
            }
        } catch (e) {
            throw new Error('[OpenMicrofrontends] Loading assets of Microfrontend "<%-spec.microfrontends[i].name%>" failed!');
        }
    <% } %>

    const renderFunction = exportedModules.find(m => '<%-spec.microfrontends[i].rendererFunctionName-%>' in m)?.['<%-spec.microfrontends[i].rendererFunctionName-%>']
            || exportedModules.find(m => 'default' in m && '<%-spec.microfrontends[i].rendererFunctionName-%>' in m.default)?.default?.['<%-spec.microfrontends[i].rendererFunctionName-%>']
            || (window as any)['<%-spec.microfrontends[i].rendererFunctionName-%>'];
    if (!renderFunction) {
        throw new Error('[OpenMicrofrontends] Renderer of Microfrontend "<%-spec.microfrontends[i].name%>" not found!');
    }

    const apiProxyPaths = {};
    <% if (spec.microfrontends[i].apiProxies && Object.keys(spec.microfrontends[i].apiProxies).length > 0) { %>
        <% Object.keys(spec.microfrontends[i].apiProxies).forEach((proxyId) => { %>
            apiProxyPaths['<%-proxyId%>'] = `${proxiesPath}/<%-proxyId%>`;
        <% }) %>
    <% } %>

    const contextWithDefaultConfig = {
        ...serverContext,
        ...context,
        apiProxyPaths,
        serverSideRendered,
        config: {
            ...defaultConfig<%i+1%>,
            ...context.config,
        },
    };

    // Render the Microfrontend
    console.info('[OpenMicrofrontends] Starting Microfrontend "<%-spec.microfrontends[i].name%>"');
    const lifecycleHooks = await renderFunction(hostElement, contextWithDefaultConfig);

    return {
        close: async () => {
            console.info('[OpenMicrofrontends] Closing Microfrontend "<%-spec.microfrontends[i].name%>"');
            await lifecycleHooks?.onRemove();
            addedElements.forEach((elem) => elem.remove());
            hostElement.innerHTML = '';
        },
        <% if (spec.microfrontends[i].messages && Object.keys(spec.microfrontends[i].messages).length > 0) { %>
            messages: context.messageBus as Microfrontend<%-i+1-%>ClientMessageBus,
        <% } %>
    };
};
