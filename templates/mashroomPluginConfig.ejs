{
    "$schema": "https://www.mashroom-server.com/schemas/mashroom-plugins.json",
    "plugins": [
    <% for (let i = 0; i < spec.microfrontends.length; i ++) { %>
        {
            "name": "<%-spec.microfrontends[i].name%>",
            "type": "portal-app2",
            <% if (spec.microfrontends[i].description) { %>
            "description": <%-JSON.stringify(spec.microfrontends[i].description, null, 4)-%>,
            <% } %>
            "clientBootstrap": "<%-spec.microfrontends[i].globalLaunchFunction%>",
            "resources": <%-JSON.stringify(spec.microfrontends[i].resources, null, 4)-%>,
            "local": {
                "resourcesRoot": "./unknown-local-not-supported"
            },
            "remote": {
                <% if (spec.microfrontends[i].paths.ssrHtml) { %>
                "ssrInitialHtmlPath": "<%-spec.microfrontends[i].paths.ssrHtml-%>",
                <% } %>
                "resourcesRoot": "<%-spec.microfrontends[i].paths.resourcesBase%>"
            },
            "defaultConfig": {
                <% if (spec.microfrontends[i].title) { %>
                "title": <%-JSON.stringify(spec.microfrontends[i].title, null, 4)-%>,
                <% } %>
                <% if (additionalProperties.mashroomCategory) { %>
                "category": "<%-additionalProperties.mashroomCategory-%>",
                <% } %>
                <% if (spec.microfrontends[i].annotations?.['MASHROOM_CATEGORY']) { %>
                "category": "<%-spec.microfrontends[i].annotations['MASHROOM_CATEGORY']-%>",
                <% } %>
                <% if (spec.microfrontends[i].annotations?.['MASHROOM_VIEW_ROLES']) { %>
                "defaultRestrictViewToRoles": <%-JSON.stringify(spec.microfrontends[i].annotations['MASHROOM_VIEW_ROLES'])-%>,
                <% } %>
                <% if (spec.microfrontends[i].frontendPermissions && spec.microfrontends[i].frontendPermissions.length > 0) { %>
                "rolePermissions": {
                    <% spec.microfrontends[i].frontendPermissions.forEach((permissionKey, idx, array) => { %>
                    "<%-permissionKey-%>": <%-JSON.stringify(spec.microfrontends[i].annotations?.['MASHROOM_FRONTEND_PERMISSIONS_MAPPING']?.[permissionKey] ?? [])-%><%-idx < array.length - 1 ? ',' : ''-%>
                    <% }) %>
                },
                <% } %>
                <% if (spec.microfrontends[i].apiProxies && Object.keys(spec.microfrontends[i].apiProxies).length > 0) { %>
                "proxies": {
                <% Object.keys(spec.microfrontends[i].apiProxies).forEach((proxyId, idx, array) => { %>
                    "<%-proxyId-%>": {
                        <% if (typeof spec.microfrontends[i].apiProxies[proxyId] === 'string') { %>
                        "targetUri": "<%-spec.microfrontends[i].apiProxies[proxyId]-%>",
                        <% } %>
                        <% if (typeof spec.microfrontends[i].apiProxies[proxyId] === 'object') { %>
                        "targetUri": "<%-spec.microfrontends[i].apiProxies[proxyId].url-%>",
                        <% } %>
                        <% if (spec.microfrontends[i].annotations?.['MASHROOM_PROXY_ACCESS_ROLES']?.[proxyId]) { %>
                        "restrictToRoles": <%-JSON.stringify(spec.microfrontends[i].annotations['MASHROOM_PROXY_ACCESS_ROLES'][proxyId])-%>,
                        <% } %>
                        "sendPermissionsHeader": true
                    }<%-idx < array.length - 1 ? ',' : ''-%>
                <% }) %>
                },
                <% } %>
                <% if (additionalProperties.mashroomMetaInfoAnnotations) { %>
                "metaInfo": {
                    "openMicrofrontends": true,
                    "openMicrofrontendsVersion": "<%-spec.openMicrofrontends-%>",
                    <% additionalProperties.mashroomMetaInfoAnnotations.split(',').forEach((annotationId, idx, array) => { %>
                    "<%-annotationId-%>": <%-JSON.stringify(spec.microfrontends[i].annotations?.[annotationId], null, 4)-%><%-idx < array.length - 1 ? ',' : ''-%>
                    <% }) %>
                },
                <% } %>
                "caching": {
                    "ssrHtml": "same-config"
                },
                "appConfig": <%-JSON.stringify(spec.microfrontends[i].config.default, null, 4)-%>
            }
        }
    <% } %>
    ]
}
