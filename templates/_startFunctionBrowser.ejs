
// Start function for Microfrontend: <%-spec.microfrontends[i].name%>
export async function start<%-safeMicrofrontendNames[i]-%>(serverUrl: string, hostElement: HTMLElement, context: Microfrontend<%-i+1-%>Context) {
    const addedElements: Array<HTMLElement> = [];

    // Load resources
    const jsPromises: Array<Promise<void>> = [
        <% for (const jsResource of spec.microfrontends[i].resources.js) { %>
        loadJsResource(toFullUrl(serverUrl, '<%-spec.microfrontends[i].paths.resourcesBase-%>', '<%-jsResource%>'), addedElements),
        <% } %>
    ];
    <% if (spec.microfrontends[i].resources.css) { %>
    <% for (const cssResource of spec.microfrontends[i].resources.css) { %>
    loadCssResource(toFullUrl(serverUrl, '<%-spec.microfrontends[i].paths.resourcesBase-%>', '<%-cssResource%>'), addedElements);
    <% } %>
    <% } %>

    try {
        await Promise.all(jsPromises);
    } catch (e) {
        console.error('[OpenMicrofrontends] Loading resources of Microfrontend "<%-spec.microfrontends[i].name%>" failed!', e);
        return;
    }

    // Start Microfrontend
    const renderFunction = (window as any)['<%-spec.microfrontends[i].globalLaunchFunction-%>'];
    if (!renderFunction) {
        console.error('[OpenMicrofrontends] Render function of Microfrontend "<%-spec.microfrontends[i].name%>" not found!');
        return;
    }

    <% if (additionalProperties.shadowDOM === 'true') { %>
    console.info('[OpenMicrofrontends] Using Shadow DOM for Microfrontend "<%-spec.microfrontends[i].name%>"');
    hostElement = hostElement.attachShadow({ mode: "open" }).getRootNode() as HTMLElement;
    <% } %>

    const lifecycleHooks = await renderFunction(hostElement, context);

    return {
        close: async () => {
            console.info('[OpenMicrofrontends] Closing Microfrontend "<%-spec.microfrontends[i].name%>"');
            await lifecycleHooks?.onRemove();
            addedElements.forEach((elem) => elem.remove());
            hostElement.innerHTML = '';
        },
        <% if (spec.microfrontends[i].messages && Object.keys(spec.microfrontends[i].messages).length > 0) { %>
        messages: context.messageBus as Microfrontend<%-i+1-%>ClientMessageBus,
        <% } %>
    };
}
